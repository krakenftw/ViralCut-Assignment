import { useState, useEffect } from "react";
import { Transcript } from "../../App";
import EachWord from "./EachWord";
import Controls from "./Controls";

function TranscriptEditor({
  initialTranscript,
}: {
  initialTranscript: Transcript[];
}) {
  const [currentTime, setCurrentTime] = useState(0);
  const [isActive, setIsActive] = useState<number | null>(null);

  useEffect(() => {
    let interval: NodeJS.Timeout;

    startPlayback();

    return () => {
      clearInterval(interval);
    };
  }, [initialTranscript]);

  const startPlayback = () => {
    interval = setInterval(() => {
      setCurrentTime((prevTime) => {
        const newTime = prevTime + 50;
        const activeWordIndex = initialTranscript.findIndex(
          (word) =>
            newTime >= word.start_time &&
            newTime < word.start_time + word.duration,
        );

        if (activeWordIndex !== -1) {
          setIsActive(activeWordIndex);
        } else {
          setIsActive(null);
          clearInterval(interval);
          setCurrentTime(0);
        }

        return newTime;
      });
    }, 50);
  };

  return (
    <div className="w-1/2 ">
      <span className="p-2 rounded-lg text-white bg-gray-500">
        {(currentTime / 1000).toFixed(1)}s
      </span>
      <div className="flex flex-wrap gap text-xl leading-relaxed ">
        {initialTranscript.map((eachWord, index) => (
          <EachWord
            key={index}
            index={index}
            word={eachWord}
            isActive={isActive}
          />
        ))}
      </div>
      <div className="flex text-white items-center justify-center">
        <Controls />
      </div>
    </div>
  );
}

export default TranscriptEditor;
